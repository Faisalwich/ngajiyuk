<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kompas Kiblat - NgajiYuk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
      /* Animasi jarum kompas biar mulus */
      #compass-ring {
        transition: transform 0.2s ease-out;
      }
      #qibla-pointer {
        transition: transform 0.2s ease-out;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-100 min-h-screen flex flex-col relative pb-10 text-slate-800 overflow-hidden">
    <div class="fixed top-0 left-0 w-64 h-64 bg-emerald-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 -z-10"></div>
    <div class="fixed bottom-0 right-0 w-64 h-64 bg-cyan-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 -z-10"></div>

    <div class="p-6 flex items-center justify-between relative z-10 max-w-md mx-auto w-full">
      <a href="index.html" class="w-12 h-12 glass-panel rounded-2xl flex items-center justify-center text-emerald-700 text-xl font-bold shadow-sm hover:bg-white active:scale-90 transition-all">‚Üê</a>
      <h1 class="text-xl font-extrabold text-slate-800 tracking-tight">Arah Kiblat</h1>
      <div class="w-12 h-12"></div>
    </div>

    <div class="flex-1 w-full max-w-md mx-auto px-6 relative z-10 flex flex-col items-center justify-center -mt-10">
      <div class="text-center mb-10">
        <h2 class="text-3xl font-black text-slate-800 mb-2">Penunjuk Arah</h2>
        <p id="status-text" class="text-slate-500 text-sm">Tekan tombol di bawah untuk kalibrasi.</p>
      </div>

      <div class="relative w-72 h-72 sm:w-80 sm:h-80 flex items-center justify-center bg-white/50 backdrop-blur-md rounded-full shadow-2xl border-4 border-white mb-10">
        <div id="compass-ring" class="absolute w-full h-full flex flex-col items-center justify-between py-4 text-emerald-700 font-bold text-xl">
          <span>U</span>
          <div class="flex w-full justify-between px-4"><span>B</span><span>T</span></div>
          <span>S</span>
        </div>

        <div id="qibla-pointer" class="absolute w-full h-full flex items-start justify-center pt-8 hidden">
          <div class="w-2 h-32 bg-emerald-500 rounded-full shadow-lg relative">
            <div class="absolute -top-3 -left-3 w-8 h-8 bg-emerald-600 rounded-full border-4 border-white flex items-center justify-center">
              <div class="w-2 h-2 bg-white rounded-full"></div>
            </div>
          </div>
        </div>

        <div class="w-4 h-4 bg-slate-800 rounded-full z-20 border-2 border-white shadow-sm"></div>
      </div>

      <button
        id="btn-start"
        class="w-full max-w-[200px] bg-slate-900 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2"
      >
        üß≠ Aktifkan Kompas
      </button>

      <div id="info-box" class="mt-8 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 w-full hidden text-center">
        <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Sudut Kiblat Daerahmu</p>
        <p id="qibla-degree" class="text-2xl font-black text-emerald-600">0¬∞</p>
      </div>
    </div>

    <script>
      const btnStart = document.getElementById("btn-start");
      const statusText = document.getElementById("status-text");
      const compassRing = document.getElementById("compass-ring");
      const qiblaPointer = document.getElementById("qibla-pointer");
      const infoBox = document.getElementById("info-box");
      const qiblaDegreeText = document.getElementById("qibla-degree");

      let qiblaAngle = 0; // Sudut Ka'bah dari Utara

      btnStart.addEventListener("click", async () => {
        btnStart.classList.add("hidden");
        statusText.innerText = "Mencari satelit GPS...";

        // 1. Minta Izin Lokasi
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              statusText.innerText = "Menghitung derajat Ka'bah...";

              // 2. Ambil data Kiblat dari API Aladhan
              fetch(`https://api.aladhan.com/v1/qibla/${lat}/${lng}`)
                .then((res) => res.json())
                .then((data) => {
                  qiblaAngle = data.data.direction;
                  qiblaDegreeText.innerText = Math.round(qiblaAngle) + "¬∞ dari Utara";
                  infoBox.classList.remove("hidden");
                  qiblaPointer.classList.remove("hidden");
                  statusText.innerText = "Putar HP-mu untuk mencari arah.";

                  // 3. Nyalakan Sensor Kompas (Gyroscope/Magnetometer)
                  startCompass();
                })
                .catch((err) => {
                  statusText.innerText = "Gagal mengambil data arah Kiblat.";
                  btnStart.classList.remove("hidden");
                });
            },
            (error) => {
              statusText.innerText = "Akses lokasi ditolak. Aktifkan GPS!";
              btnStart.classList.remove("hidden");
            },
          );
        } else {
          statusText.innerText = "Browser kamu tidak support GPS.";
        }
      });

      function startCompass() {
        // Khusus untuk iOS (iPhone) harus minta izin permission khusus
        if (typeof DeviceOrientationEvent.requestPermission === "function") {
          DeviceOrientationEvent.requestPermission()
            .then((permissionState) => {
              if (permissionState === "granted") {
                window.addEventListener("deviceorientation", handleOrientation);
              } else {
                statusText.innerText = "Izin sensor kompas ditolak.";
              }
            })
            .catch(console.error);
        } else {
          // Untuk Android dan browser biasa
          window.addEventListener("deviceorientationabsolute", handleOrientation) || window.addEventListener("deviceorientation", handleOrientation);
        }
      }

      function handleOrientation(event) {
        let compassHeading;
        // Cari tau arah Utara HP (beda-beda tiap HP/OS)
        if (event.webkitCompassHeading) {
          compassHeading = event.webkitCompassHeading; // iOS
        } else if (event.alpha) {
          // Konversi alpha Android ke arah kompas (pendekatan kasar)
          compassHeading = Math.abs(event.alpha - 360);
        }

        if (compassHeading !== undefined) {
          // Putar UI Kompas dan Jarum Kiblat
          compassRing.style.transform = `rotate(${-compassHeading}deg)`;
          // Jarum kiblat berputar berdasarkan arah utara HP + sudut Ka'bah
          qiblaPointer.style.transform = `rotate(${qiblaAngle - compassHeading}deg)`;
        }
      }
    </script>
  </body>
</html>
